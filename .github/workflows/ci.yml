name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Free disk space (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-${{ matrix.rust }}

      - name: Build workspace (default features)
        run: cargo build --workspace --verbose

      - name: Run unit and integration tests (default features)
        run: cargo test --workspace --verbose

      - name: Run documentation tests (default features)
        run: cargo test --doc --workspace --verbose

      - name: Test metrics feature
        run: cargo test -p metafuse-catalog-api --features metrics --verbose

  security-features:
    name: Security Features Matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        features:
          - "rate-limiting"
          - "api-keys"
          - "rate-limiting,api-keys"
          - "rate-limiting,api-keys,metrics"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Sanitize feature string for cache key
        id: sanitize
        run: echo "features_sanitized=$(echo '${{ matrix.features }}' | tr ',' '-')" >> $GITHUB_OUTPUT

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: security-${{ steps.sanitize.outputs.features_sanitized }}

      - name: Build with features (${{ matrix.features }})
        run: cargo build -p metafuse-catalog-api --features "${{ matrix.features }}" --verbose

      - name: Test with features (${{ matrix.features }})
        run: cargo test -p metafuse-catalog-api --features "${{ matrix.features }}" --verbose

      - name: Build release with features (${{ matrix.features }})
        run: cargo build -p metafuse-catalog-api --release --features "${{ matrix.features }}" --verbose

  examples:
    name: Examples Smoke Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Build examples
        run: |
          cargo build --example simple_pipeline --verbose
          cargo build --example lineage_tracking --verbose

      - name: Run simple_pipeline example
        run: cargo run --example simple_pipeline

      - name: Run lineage_tracking example
        run: cargo run --example lineage_tracking

  build-release:
    name: Build Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Build release binary (default features)
        run: cargo build --release --workspace --verbose

      - name: Build release binary (with metrics)
        run: cargo build --release -p metafuse-catalog-api --features metrics --verbose

      - name: Check binary size
        run: |
          ls -lh target/release/metafuse || echo "CLI binary not found"
          ls -lh target/release/metafuse-api || echo "API binary not found"

  benchmarks:
    name: Benchmark Compile Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: benchmarks-linux

      - name: Check benchmark compilation
        run: cargo bench --no-run --verbose
